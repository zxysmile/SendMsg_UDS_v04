/*@@var:*/
variables
{
    mstimer Timer0;
    word ms1_counter = 0;
    word ms1_cnt_BSI_cmd = 0;
    word ms1_cnt_BSI_Spd = 0;
    word ms1_cnt_BSI_ACC = 0;
    word ms1_cnt_BSI_VCI = 0;

    message 0x036   Msg_BSI_Commands;
    message 0x0B6   Msg_BSI_SpdInf;
    message 0x0F6   Msg_BSI_ACCInf;
    message 0x21F   Msg_BSI_VCI;

    byte fstart = 0;

    byte fkey_q = 0;

}
/*@@end*/

/*@@timer:Timer0:*/
on timer Timer0
{
    ms1_counter++;
    
    if(fstart == 1)
    {
        if(ms1_cnt_BSI_cmd != 0) ms1_cnt_BSI_cmd--;
        if(ms1_cnt_BSI_Spd != 0) ms1_cnt_BSI_Spd--;
        if(ms1_cnt_BSI_ACC != 0) ms1_cnt_BSI_ACC--;
        if(ms1_cnt_BSI_VCI != 0) ms1_cnt_BSI_VCI--; 

         /* send 0x036  period:100ms */
        if(ms1_cnt_BSI_cmd == 0)
        {
            ms1_cnt_BSI_cmd = 100;
            Trans_Msg_BSI_Commands();
        }       

        /* send 0x0F6  period:500ms */
        if(ms1_cnt_BSI_ACC == 0)
        {
            ms1_cnt_BSI_ACC = 500;
            Trans_Msg_BSI_ACCInf();
        }

        /* send 0x0B6  period:50ms */
        if(ms1_cnt_BSI_Spd == 0)
        {
            ms1_cnt_BSI_Spd = 50;
            Trans_Msg_BSI_SpdInf();
        }     
    }
    else
    {
        ms1_cnt_BSI_cmd = 0;
        ms1_cnt_BSI_Spd = 0;
        ms1_cnt_BSI_VCI = 0;
        ms1_cnt_BSI_ACC = 0; 
    }
    
    settimer(Timer0,1);
}
/*@@end*/

/*@@startStart:Start:*/
on start
{
    settimer(Timer0,50);
}
/*@@end*/

/*@@envVar:Env_BSI_StartSW:*/
on envVar Env_BSI_StartSW
{
    byte temp_val;

    temp_val = getvalue(Env_BSI_StartSW);

    if(temp_val == 1)
    {
        if(fstart == 1)
        {
            fstart = 0;
            putvalue(Env_PWR_ON_Display, 0);
        }
        else
        {
            fstart = 1;
            putvalue(Env_PWR_ON_Display, 1);

            //offset
            ms1_cnt_BSI_cmd = 0;
            ms1_cnt_BSI_Spd = 20;
            ms1_cnt_BSI_ACC = 240;
            ms1_cnt_BSI_VCI = 100;
        }
    }

    
}
/*@@end*/

/*@@key:'q':*/
on key 'q'
{
    if(fkey_q == 1)
    {
        fkey_q = 0;
    }
    else
    {
        fkey_q = 1;
    }
}
/*@@end*/

/*@@caplFunc:Trans_Msg_BSI_Commands():*///function
void Trans_Msg_BSI_Commands(void)
{
    Msg_BSI_Commands.DLC = 0x08;
    Msg_BSI_Commands.byte(0) = 0x00;
    Msg_BSI_Commands.byte(1) = 0x00;
    Msg_BSI_Commands.byte(2) = 0x00;
    Msg_BSI_Commands.byte(3) = 0x08;
    Msg_BSI_Commands.byte(4) = 0x01;
    Msg_BSI_Commands.byte(5) = 0x00;
    Msg_BSI_Commands.byte(6) = 0x00;
    Msg_BSI_Commands.byte(7) = 0x00;

    output(Msg_BSI_Commands);
}
/*@@end*/

/*@@caplFunc:Trans_Msg_BSI_SpdInf():*///function
void Trans_Msg_BSI_SpdInf(void)
{
    Msg_BSI_SpdInf.DLC = 0x08;
    Msg_BSI_SpdInf.byte(0) = 0x00;
    Msg_BSI_SpdInf.byte(1) = 0x00;
    Msg_BSI_SpdInf.byte(2) = 0x00;
    Msg_BSI_SpdInf.byte(3) = 0x01;
    Msg_BSI_SpdInf.byte(4) = 0x00;
    Msg_BSI_SpdInf.byte(5) = 0x00;
    Msg_BSI_SpdInf.byte(6) = 0x00;
    Msg_BSI_SpdInf.byte(7) = 0x80;

    output(Msg_BSI_SpdInf);
}
/*@@end*/

/*@@caplFunc:Trans_Msg_BSI_ACCInf():*///function
void Trans_Msg_BSI_ACCInf(void)
{
    Msg_BSI_ACCInf.DLC = 0x08;
    Msg_BSI_ACCInf.byte(0) = 0x08;
    Msg_BSI_ACCInf.byte(1) = 0x04;
    Msg_BSI_ACCInf.byte(2) = 0x00;
    Msg_BSI_ACCInf.byte(3) = 0x00;
    Msg_BSI_ACCInf.byte(4) = 0x03;
    Msg_BSI_ACCInf.byte(5) = 0x00;
    Msg_BSI_ACCInf.byte(6) = 0x00;
    Msg_BSI_ACCInf.byte(7) = 0x00;

    output(Msg_BSI_ACCInf);
}
/*@@end*/

/*@@caplFunc:Trans_Msg_BSI_VCI():*///function
void Trans_Msg_BSI_VCI(void)
{
}
/*@@end*/

